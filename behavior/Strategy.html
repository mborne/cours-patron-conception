<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <title>Strategy</title>
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
  </head>
  <body>
    <article class="markdown-body"><h1 id="strategy"><a class="header-link" href="#strategy"></a>Strategy</h1>
<h2 id="problème"><a class="header-link" href="#problème"></a>Problème</h2>
<p>On souhaite pouvoir faire varier dynamiquement le comportement d&#39;une partie
d&#39;un traitement.</p>
<h2 id="exemple"><a class="header-link" href="#exemple"></a>Exemple</h2>
<h3 id="cas-d'école-sur-un-traitement-simple"><a class="header-link" href="#cas-d'école-sur-un-traitement-simple"></a>Cas d&#39;école sur un traitement simple</h3>
<p>Prenons le cas d&#39;une application qui applique les trois étapes suivantes :</p>
<ul class="list">
<li>Charger une image PNG</li>
<li>Passer l&#39;image en niveau de gris</li>
<li>Stocker l&#39;image résultante</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">class</span> Application {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">run</span>(<span class="hljs-built_in">File</span> input, <span class="hljs-built_in">File</span> output){
        Image <span class="hljs-built_in">image</span> = readImagePNG(input);
        grayScale(<span class="hljs-built_in">image</span>) ;
        writeImagePNG(<span class="hljs-built_in">image</span>,output)
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> grayScale(Image <span class="hljs-built_in">image</span>){
        <span class="hljs-comment">// Transforme en niveau de gris</span>
    }

    <span class="hljs-keyword">protected</span> Image readImagePNG(<span class="hljs-built_in">File</span> input){
        <span class="hljs-comment">// Chargement de l'image PNG</span>
    }

    <span class="hljs-keyword">protected</span> Image writeImagePNG(<span class="hljs-built_in">File</span> output, Image <span class="hljs-built_in">image</span>){
        <span class="hljs-comment">// Sauvegarde de l'image PNG</span>
    }
}</code></pre><p>On expose cette classe sous forme d&#39;un exécutable appelé ainsi :</p>
<pre class="hljs"><code>traitement-image <span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.png</span> output.png</code></pre><pre class="hljs"><code><span class="hljs-keyword">class</span> ApplicationCLI {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-keyword">String</span> args[]){
        <span class="hljs-built_in">File</span> input  = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(args[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">File</span> output = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(args[<span class="hljs-number">1</span>]);
        Application application = <span class="hljs-keyword">new</span> Application();
        application.<span class="hljs-built_in">run</span>(input,output);
    }

}</code></pre><p>On souhaite maintenant permettre le choix sur le traitement appliqué :</p>
<pre class="hljs"><code>traitement-image &lt;input&gt; &lt;output&gt; [<span class="hljs-function"><span class="hljs-keyword">method</span>]
<span class="hljs-title">method</span> :</span>= grayScale|blur</code></pre><h3 id="première-tentative-sans-strategy-(switch)"><a class="header-link" href="#première-tentative-sans-strategy-(switch)"></a>Première tentative sans strategy (switch)</h3>
<pre class="hljs"><code><span class="hljs-keyword">class</span> Application {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">run</span>(<span class="hljs-built_in">File</span> input, <span class="hljs-built_in">File</span> output, <span class="hljs-keyword">String</span> method){
        Image <span class="hljs-built_in">image</span> = readImagePNG(input);
        <span class="hljs-built_in">if</span> ( method.equals(<span class="hljs-string">"grayScale"</span>) ){
            grayScale(<span class="hljs-built_in">image</span>) ;
        }<span class="hljs-built_in">else</span> <span class="hljs-built_in">if</span> ( method.equals(<span class="hljs-string">"blur"</span>) ){
            blur(<span class="hljs-built_in">image</span>) ;
        }
        writeImagePNG(<span class="hljs-built_in">image</span>,output);
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> grayScale(Image <span class="hljs-built_in">image</span>){
        <span class="hljs-comment">// Applique un grayScale sur l'image</span>
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> blur(Image <span class="hljs-built_in">image</span>){
        <span class="hljs-comment">// Applique un blur sur l'image</span>
    }

    <span class="hljs-keyword">protected</span> Image readImagePNG(<span class="hljs-built_in">File</span> input){
        <span class="hljs-comment">// Chargement de l'image PNG</span>
    }

    <span class="hljs-keyword">protected</span> Image writeImagePNG(<span class="hljs-built_in">File</span> output, Image <span class="hljs-built_in">image</span>){
        <span class="hljs-comment">// Sauvegarde de l'image PNG</span>
    }
}</code></pre><p>Problème :</p>
<ul class="list">
<li>Ajouter un algorithme implique la mise à jour de run (Violation du principe ouvert/fermé)</li>
<li>La classe Application aura tendance à devenir un objet divin</li>
<li>A terme, si les algorithmes ont des paramètres spécifiques, il faudra ajouter des attributs sur la classe Application</li>
</ul>
<h3 id="deuxième-tentative-sans-strategy-(abstract)"><a class="header-link" href="#deuxième-tentative-sans-strategy-(abstract)"></a>Deuxième tentative sans strategy (abstract)</h3>
<p>Exploitons donc le polymorphisme!</p>
<ul class="list">
<li>Classe abstraite Application</li>
</ul>
<pre class="hljs"><code>abstract <span class="hljs-keyword">class</span> Application {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">run</span>(<span class="hljs-built_in">File</span> input, <span class="hljs-built_in">File</span> output){
        Image <span class="hljs-built_in">image</span> = readImagePNG(input);
        <span class="hljs-built_in">process</span>(<span class="hljs-built_in">image</span>);
        writeImagePNG(<span class="hljs-built_in">image</span>,output);
    }

    <span class="hljs-keyword">public</span> abstract <span class="hljs-keyword">void</span> <span class="hljs-built_in">process</span>(Image <span class="hljs-built_in">image</span>) ;

    <span class="hljs-keyword">public</span> Image readImagePNG(<span class="hljs-built_in">File</span> input){
        <span class="hljs-comment">// Chargement de l'image PNG</span>
    }

    <span class="hljs-keyword">public</span> Image writeImagePNG(<span class="hljs-built_in">File</span> output, Image <span class="hljs-built_in">image</span>){
        <span class="hljs-comment">// Sauvegarde de l'image PNG</span>
    }
}</code></pre><ul class="list">
<li>Implémentation GrayScale</li>
</ul>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationGrayScale</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Application</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> static <span class="hljs-type">String</span> <span class="hljs-type">NAME</span> = <span class="hljs-string">"grayScale"</span> ;

    public void process(<span class="hljs-type">Image</span> image){
        <span class="hljs-comment">// applique traitement grayScale...</span>
    }
}</code></pre><ul class="list">
<li>Implémentation Blur</li>
</ul>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplicationBlur</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Application</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> static <span class="hljs-type">String</span> <span class="hljs-type">NAME</span> = <span class="hljs-string">"blur"</span> ;

    public void process(<span class="hljs-type">Image</span> image){
        <span class="hljs-comment">// applique traitement blur...</span>
    }
}</code></pre><ul class="list">
<li>ApplicationCLI</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">class</span> ApplicationCLI {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-keyword">String</span> args[]){
        <span class="hljs-built_in">File</span> input    = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(args[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">File</span> output   = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(args[<span class="hljs-number">1</span>]);    
        <span class="hljs-keyword">String</span> method = args[<span class="hljs-number">2</span>] ;

        Map&lt;<span class="hljs-keyword">String</span>, Application&gt; applications = <span class="hljs-keyword">new</span> HashMap&lt;<span class="hljs-keyword">String</span>, Application&gt;();
        applications.<span class="hljs-built_in">put</span>(ApplicationGrayScale.NAME, <span class="hljs-keyword">new</span> ApplicationGrayScale());
        applications.<span class="hljs-built_in">put</span>(ApplicationBlur.NAME, <span class="hljs-keyword">new</span> ApplicationBlur());

        Application application = applications.<span class="hljs-built_in">get</span>(method);
        application.<span class="hljs-built_in">run</span>(input,output);
    }

}</code></pre><p>A première vue, on pourrait être satisfait d&#39;une telle conception. Dommage :
On souhaite maintenant pouvoir appliquer deux traitements successifs !</p>
<p>Avec l&#39;héritage, on obtient soit :</p>
<ul class="list">
<li>Une explosion combinatoire (ApplicationBlur, ApplicationGrayScale, ApplicationGrayScaleBlur, ApplicationBlurGrayScale)</li>
<li>Des écritures/relectures de fichiers</li>
</ul>
<p>Qu&#39;est-ce qu&#39;on a raté : </p>
<ul class="list">
<li>Le principe de responsabilité unique (Application effectue le calcul tout en orchestrant la lecture et les écritures).</li>
<li>Privilégier la composition à l&#39;héritage s&#39;applique aussi pour l&#39;encapsulation des traitements.</li>
</ul>
<h3 id="solution-avec-une-stratégie"><a class="header-link" href="#solution-avec-une-stratégie"></a>Solution avec une stratégie</h3>
<p>Au lieu d&#39;hériter, on va encapsuler un objet dont le seul rôle se limitera à appliquer le traitement.</p>
<ul class="list">
<li>ImageProcessorStrategy : Interface pour la stratégie de traitement</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">interface</span> <span class="hljs-title">ImageProcessorStrategy</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span>(<span class="hljs-params">Image image</span>) </span>;
}</code></pre><ul class="list">
<li>Application encapsulant un traitement</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">class</span> Application {

    <span class="hljs-keyword">private</span> ImageProcessorStrategy processor ;

    <span class="hljs-keyword">public</span> Application(ImageProcessorStrategy processor){
        <span class="hljs-keyword">this</span>.processor = processor ;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">run</span>(<span class="hljs-built_in">File</span> input, <span class="hljs-built_in">File</span> output){
        Image <span class="hljs-built_in">image</span> = readImagePNG(input);
        processor.<span class="hljs-built_in">process</span>(<span class="hljs-built_in">image</span>);
        writeImagePNG(<span class="hljs-built_in">image</span>,output);
    }

    <span class="hljs-keyword">public</span> Image readImagePNG(<span class="hljs-built_in">File</span> input){
        <span class="hljs-comment">// Chargement de l'image PNG</span>
    }

    <span class="hljs-keyword">public</span> Image writeImagePNG(<span class="hljs-built_in">File</span> output, Image <span class="hljs-built_in">image</span>){
        <span class="hljs-comment">// Sauvegarde de l'image PNG</span>
    }
}</code></pre><ul class="list">
<li>Implémentation de la stratégie GrayScale</li>
</ul>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageProcessorGrayScale</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ImageProcessorStrategy</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String NAME = <span class="hljs-string">"grayScale"</span> ;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(Image image)</span></span>{
        <span class="hljs-comment">// applique traitement grayScale...</span>
    }

}</code></pre><ul class="list">
<li>Implémentation Blur</li>
</ul>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageProcessorBlur</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ImageProcessorStrategy</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String NAME = <span class="hljs-string">"blur"</span> ;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(Image image)</span></span>{
        <span class="hljs-comment">// applique traitement blur...</span>
    }
}</code></pre><ul class="list">
<li><a href="../structural/Composite.html">Composite</a> sur ImageProcessorStrategy</li>
</ul>
<pre class="hljs"><code><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageProcessorComposite</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ImageProcessorStrategy</span> </span>{

    <span class="hljs-keyword">private</span> List&lt;ImageProcessorStrategy&gt; strategies ;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ImageProcessorComposite</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">this</span>.strategies = <span class="hljs-keyword">new</span> ArrayList&lt;ImageProcessorStrategy&gt;();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(ImageProcessorStrategy strategy)</span></span>{
        <span class="hljs-keyword">this</span>.strategies.add(strategy) ;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(Image image)</span></span>{
        <span class="hljs-comment">// applique les sous-stratégies</span>
        <span class="hljs-keyword">for</span> ( ImageProcessorStrategy strategy : strategies ){
            strategy.process(image);
        }
    }

}</code></pre><ul class="list">
<li>A l&#39;utilisation</li>
</ul>
<pre class="hljs"><code>File input    = <span class="hljs-keyword">new</span> <span class="hljs-type">File</span>(args[<span class="hljs-number">0</span>]);
File output   = <span class="hljs-keyword">new</span> <span class="hljs-type">File</span>(args[<span class="hljs-number">1</span>]);    

<span class="hljs-comment">// On imagera qu'on peut gérer le paramètre méthode sous forme d'une expression.</span>
ImageProcessorComposite compositeStrategy = <span class="hljs-keyword">new</span> <span class="hljs-type">ImageProcessorComposite</span>();
compositeStrategy.add(<span class="hljs-keyword">new</span> <span class="hljs-type">ApplicationGrayScale</span>());
compositeStrategy.add(<span class="hljs-keyword">new</span> <span class="hljs-type">ApplicationBlur</span>());

Application application = <span class="hljs-keyword">new</span> <span class="hljs-type">Application</span>(compositeStrategy);
application.run(input,output);</code></pre><p>Où est le changement? On peut appliquer le même principe sur la lecture ou l&#39;écriture des fichiers!</p>
    </article>
  </body>
</html>
